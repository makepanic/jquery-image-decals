jQuery.fn.imageDecals=function(a){"use strict";var b={tools:[]},c=jQuery.extend({},b,a),d=0,e=function(){return d+=1,"image-composer-uid-"+d},f={tooManyDecals:"too-many-decals",decalItemFocusChanged:"decal-item-focus-changed",decalPaletteItemClicked:"decal-palette-item-clicked",decalActionClicked:"decal-action-clicked",decalItemClicked:"decal-item-clicked"},g=function(a,b){var c=this,d=function(){},e={maxDecals:-1,actions:[],actionBar:void 0,showActions:!1,actionTemplate:void 0,decalTagIsImg:!1,useImageSrcDimension:!0,clickUnfocus:!1,resizable:!1,showPalette:!1,clickable:!1,draggable:!1,scaleDecalDimension:!1,domain:{width:100,height:100},decals:[],data:[],events:{onDecalClicked:d,onTooManyDecals:d}};this.selectedDecal=null,this.img=new h(a),this.cfg=jQuery.extend({},e,b),this.scale={width:1,height:1},this.img.dimension(this.cfg.useImageSrcDimension,function(){c.init()}),this.events=this.cfg.events,this.$target=a};g.prototype={toJSON:function(){var a=this.decalHolder.toObject(),b={decals:a,domain:this.cfg.domain};return JSON.stringify(b)},init:function(){var a,b=this,c=jQuery('<div class="image-composer-decals"></div>'),d=jQuery('<div class="image-composer-palette"></div>');this.scale.width=this.img.width/this.cfg.domain.width,this.scale.height=this.img.height/this.cfg.domain.height,this.renderer=new m(this.$target,this.img,!this.cfg.resizable&&!this.cfg.clickable&&!this.cfg.resizable),this.renderer.$target.parent().find(".image-composer-canvas").append(c),this.decalHolder=new i(c,{decalTagIsImg:this.cfg.decalTagIsImg,maxDecals:this.cfg.maxDecals,clickUnfocus:this.cfg.clickUnfocus,resizable:this.cfg.resizable,modifier:this.cfg.modifier,clickable:this.cfg.clickable,draggable:this.cfg.draggable,scaleDecalDimension:this.cfg.scaleDecalDimension,dimension:{width:this.img.width,height:this.img.height},scale:this.scale,items:[]}),this.decalHolder.$target.on(f.decalItemClicked,function(a,c){b.selectedDecal=c.decal,b.cfg.showActions&&b.actionBar.show(),b.events.onDecalClicked.call(a.target,a,c.decal)}),this.decalHolder.$target.on(f.decalItemFocusChanged,function(a,c){c.focus===!1&&(b.selectedDecal=null,b.cfg.showActions&&b.actionBar.hide())}),this.decalHolder.$target.on(f.tooManyDecals,b.cfg.events.onTooManyDecals),this.cfg.showPalette&&(this.renderer.$target.parent().append(d),this.decalPalette=new k(d,this.cfg.decals),this.decalPalette.$target.on(f.decalPaletteItemClicked,function(a,c){b.decalHolder.addDecal(new j(b.cfg.decals[c.decal.key]))})),this.cfg.showActions&&(this.actionBar=new l(this.cfg.actionBar,{actions:this.cfg.actions,actionTemplate:this.cfg.actionTemplate,holder:this.decalHolder}),this.actionBar.$target.on(f.decalActionClicked,function(a,c){var d=c.action;d.trigger(b.selectedDecal,a,b.decalHolder)})),this.cfg.data.forEach(function(c){a=jQuery.extend(!0,{},b.cfg.decals[c.key]),a.width=c.width,a.height=c.height,a.left=c.left,a.top=c.top,a.allowModifier=b.cfg.allowModifier,b.decalHolder.addDecal(new j(a),!0)}),this.decalHolder.render(),this.cfg.showPalette&&this.decalPalette.render(),this.cfg.showActions&&(this.actionBar.hide(),this.actionBar.render())}};var h=function(a){var b,c,d,e=a[0];if(b="IMAGE"===e.tagName||"IMG"===e.tagName,c=a.css("background-image").length>0,!b&&!c)throw"jquery-image-composer requires an image or element with background image to work";d=b?e.getAttribute("src"):a.css("background-image"),this.width=a.width(),this.height=a.height(),this.src=d,this.img=void 0,this.$el=a};h.prototype.dimension=function(a,b){var c,d,e=this,f="[object Function]"===Object.prototype.toString.call(b);a?(d=function(){e.width=this.width,e.height=this.height,f&&b({x:this.width,y:this.height})},c=new Image,c.onload=d,c.src=this.src,this.img=c):(this.width=this.$el.width(),this.height=this.$el.height(),f&&(c=new Image,c.onload=function(){b({x:e.width,y:e.height})},c.src=this.src,this.img=c))};var i=function(a,b){var c,d=this;for(this.scale=b.scale,this.items=b.items,this.scaleDecalDimension=b.scaleDecalDimension,this.itemsMap={},c=0;c<this.items.length;c+=1)this.itemsMap[this.items[c].uid]=this.items[c];this.cfg=b,this.$target=a,this.$target.css("width",b.dimension.width+"px"),this.$target.css("height",b.dimension.height+"px"),this.cfg.clickUnfocus&&this.$target.on("click",function(a){"image-composer-decals"===a.target.className&&d.removeFocus()}),this.cfg.clickable&&this.$target.on("click",".decal",function(a){if(a.target&&a.target.getAttribute("data-uid")){var b="IMG"===a.target.tagName,c=b?a.target.parentNode:a.target,e=a.target.getAttribute("data-uid"),g=d.itemsMap.hasOwnProperty(e)?d.itemsMap[e]:void 0;d.$target.find(".image-composer-decal-selected").removeClass("image-composer-decal-selected"),jQuery(c).addClass("image-composer-decal-selected"),d.$target.trigger(f.decalItemClicked,{decal:g})}})};i.prototype={render:function(){var a,b=document.createDocumentFragment(),c=this;this.items.forEach(function(d){a=c._createElement(d),b.appendChild(a)}),this.$target.append(b),this.cfg.resizable&&this._applyResizeable(),this.cfg.draggable&&this._applyDraggable()},renderOne:function(a){var b,c;a="[object Number]"===Object.prototype.toString.call(a)?a:-1,-1!==a&&(b=this.items[a],c=this._createElement(b),this.$target.append(c),this.cfg.resizable&&this._applyResizeable(),this.cfg.draggable&&this._applyDraggable())},_applyResizeable:function(){var a,b,c=this,d=function(a,b){var d=~a.target.className.indexOf("ui-wrapper")?a.target.childNodes[0]:a.target,e=d.getAttribute("data-uid");c.itemsMap[e].width=b.size.width,c.itemsMap[e].height=b.size.height,c.items.every(function(a){var c=!1;return a.uid===e&&(a.width=b.size.width,a.height=b.size.height,c=!0),!c})};a=this.$target.find(".resizable-no-aspect-ratio"),b=this.$target.find(".resizable-aspect-ratio"),a.length&&a.resizable({containment:"parent",stop:d}),b.length&&b.resizable({containment:"parent",aspectRatio:!0,stop:d})},_applyDraggable:function(){var a=this,b=this.cfg.decalTagIsImg,c=this.$target.find(".draggable"),d={start:function(){a.$target.addClass("decal-dragged")},drag:function(b,c){a._itemOutsideHolder({left:c.position.left,top:c.position.top,width:b.target.clientWidth,height:b.target.clientHeight})?(jQuery(b.target).addClass("decal-out"),a.$target.addClass("has-decal-out")):~b.target.className.indexOf("decal-out")&&(jQuery(b.target).removeClass("decal-out"),a.$target.removeClass("has-decal-out"))},stop:function(b,c){var d,e=~b.target.className.indexOf("ui-wrapper")?b.target.childNodes[0]:b.target,f=e.getAttribute("data-uid");if(a.$target.removeClass("decal-dragged"),a.itemsMap[f].left=c.position.left,a.itemsMap[f].top=c.position.top,a.items.every(function(a){var b=!1;return a.uid===f&&(a.left=c.position.left,a.top=c.position.top,d=a,b=!0),!b}),!d)throw"y u no found item? uid="+f;a._itemOutsideHolder(d)&&a.removeDecal(d)}};if(b){var e=[],f=[];c.each(function(a,b){"IMG"===b.tagName?e.push(b.parentNode):f.push(b)}),jQuery(e).draggable(d),jQuery(f).draggable(d)}else c.length&&c.draggable(d)},_itemOutsideHolder:function(a){var b,c={x:a.left+a.width/2,y:a.top+a.height/2};return b=c.x<0||c.y<0||c.x>this.cfg.dimension.width||c.y>this.cfg.dimension.height},_createElement:function(a){var b=this.cfg.decalTagIsImg,c=document.createElement(b&&a.src?"img":"span"),d=Math.floor;return c.className=a.className||a.key,c.className+=" decal",this.cfg.draggable&&(c.className+=" draggable"),this.cfg.resizable&&(c.className+=" resizable"),c.title=a.title,c.setAttribute("data-uid",a.uid),a.src&&(b?c.setAttribute("src",a.src):c.style.backgroundImage="url("+a.src+")"),c.className+=a.resizeAspectRatio?" resizable-aspect-ratio":" resizable-no-aspect-ratio",this.scaleDecalDimension?(c.style.width=d(this.scale.width*a.width)+"px",c.style.height=d(this.scale.height*a.height)+"px"):(c.style.width=a.width+"px",c.style.height=a.height+"px"),c.style.left=d(this.scale.width*a.left)+"px",c.style.top=d(this.scale.height*a.top)+"px",c},addDecal:function(a,b){var c=-1===this.cfg.maxDecals;c||this.items.length+1<this.cfg.maxDecals?(this.items.push(a),this.itemsMap[a.uid]=a,b||this.renderOne(this.items.length-1)):!c&&this.cfg.maxDecals>-1&&this.$target.trigger(f.tooManyDecals,{number:this.items.length})},removeFocus:function(){this.$target.find(".image-composer-decal-selected").removeClass("image-composer-decal-selected"),this.$target.trigger(f.decalItemFocusChanged,{focus:!1})},removeDecal:function(a){var b=-1,c=!1;this.items.every(function(d,e){return d.uid===a.uid&&(b=e,c=!0),!c}),-1!==b&&c&&(delete this.itemsMap[a.uid],this.items.splice(b,1),this.$target.find("[data-uid="+a.uid+"]").remove())}};var j=function(a){var b={key:"",src:void 0,width:-1,height:-1,left:0,top:0,title:"",className:void 0,resizeAspectRatio:!1};a=jQuery.extend({},b,a),this.key=a.key,this.src=a.src,this.width=a.width,this.height=a.height,this.left=a.left,this.top=a.top,this.title=a.title,this.uid=e(),this.className=a.className,this.resizeAspectRatio=a.resizeAspectRatio};i.prototype.toObject=function(){var a,b=[];return this.items.forEach(function(c){a={key:c.key,width:c.width,height:c.height,left:c.left,top:c.top},b.push(a)}),b};var k=function(a,b){var c,d=this;this.items=[],this.itemsMap=b;for(c in this.itemsMap)this.itemsMap.hasOwnProperty(c)&&this.items.push(new j(this.itemsMap[c]));this.$target=a,this.$target.on("click",".decal-palette-item",function(a){if(a.target&&a.target.getAttribute("data-key")){var b=a.target.getAttribute("data-key"),c=d.itemsMap.hasOwnProperty(b)?d.itemsMap[b]:void 0;d.$target.trigger(f.decalPaletteItemClicked,{decal:c})}})};k.prototype={render:function(){var a,b,c,d,e=document.createDocumentFragment();for(a=0;a<this.items.length;a+=1)d=this.items[a],b=document.createElement("div"),b.className="decal-palette-item",c=document.createElement("div"),c.className="decal-palette-item-wrapper",d.className&&(b.className+=" "+d.className),b.setAttribute("data-key",d.key),d.src&&(b.style.backgroundImage="url("+d.src+")"),b.style.width=d.width+"px",b.style.height=d.height+"px",c.appendChild(b),e.appendChild(c);this.$target.append(e)}};var l=function(a,b){var c=this,d={actions:[],actionTemplate:void 0,holder:void 0},e=jQuery.extend({},d,b);if(this.className="decal-action-bar",this.hiddenclassName="action-bar-hidden",this.actionClassName="decal-action",this.actions={},this.template=e.actionTemplate,e.actions.forEach(function(a){c.actions[a.key]=a}),a&&a.length)this.$target=a;else{var g=document.createElement("div");g.className=this.className,this.$target=jQuery(g),e.holder.$target.parent().after(this.$target)}this.$target.on("click","."+this.actionClassName,function(a){if(a.target&&(a.target.getAttribute("data-key")||a.target.parentNode.getAttribute("data-key"))){var b=a.target.getAttribute("data-key")||a.target.parentNode.getAttribute("data-key"),d=c.actions.hasOwnProperty(b)?c.actions[b]:void 0;c.$target.trigger(f.decalActionClicked,{action:d})}})};l.prototype={hide:function(){this.$target.addClass(this.hiddenclassName)},show:function(){this.$target.removeClass(this.hiddenclassName)},render:function(){var a,b,c,d=document.createDocumentFragment();for(b in this.actions)this.actions.hasOwnProperty(b)&&(c=this.actions[b],a=document.createElement("div"),a.className=this.actionClassName,"function"==typeof this.template?a.innerHTML=this.template(c):(c.className.length&&(a.className+=" "+c.className),c.background.length&&(a.style.backgroundImage="url("+c.background+")")),a.setAttribute("data-key",c.key),d.appendChild(a));this.$target.append(d)}};var m=function(a,b,c){if(!b instanceof h)throw"need Img instance to render";a.wrap('<div class="image-composer-wrap'+(c?" image-no-interaction":"")+'"></div>'),this.$target=a,this.compImg=b,this.place()};return m.prototype.place=function(){this.$target.hide();var a=document.createElement("div");a.className="image-composer-canvas",a.appendChild(this.compImg.img),this.$target.after(a)},this.each(function(){var a=jQuery(this),b=new g(a,c);a.data("imageDecals",b)}),this};